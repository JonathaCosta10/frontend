<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Google OAuth</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 4px; }
        .button { background: #4285f4; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .button:hover { background: #3367d6; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre { background: #f0f0f0; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Google OAuth</h1>
        
        <div class="section">
            <h2>Vari√°veis de Ambiente</h2>
            <div id="env-info"></div>
        </div>
        
        <div class="section">
            <h2>Teste de Popup Real</h2>
            <button class="button" id="test-popup-btn">üöÄ Testar Popup OAuth</button>
            <div id="popup-info"></div>
        </div>
        
        <div class="section">
            <h2>Teste Google Identity Services</h2>
            <button class="button" id="test-gsi-btn">üîß Testar GSI</button>
            <div id="gsi-info"></div>
        </div>
        
        <div class="section">
            <h2>Logs</h2>
            <div id="logs"></div>
        </div>
    </div>

    <script type="module">
        // Fun√ß√£o para adicionar logs
        function addLog(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logsDiv.innerHTML += `<p class="${type}">[${timestamp}] ${message}</p>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        // Check environment variables
        const envInfo = document.getElementById('env-info');
        const popupInfo = document.getElementById('popup-info');
        const gsiInfo = document.getElementById('gsi-info');
        
        const clientId = import.meta.env.VITE_GOOGLE_CLIENT_ID || '460141148400-djs1tkkr0e4eneqmetf7gfsvotphutcu.apps.googleusercontent.com';
        const backendUrl = import.meta.env.VITE_BACKEND_URL || 'http://127.0.0.1:8000';
        
        envInfo.innerHTML = `
            <p><strong>VITE_GOOGLE_CLIENT_ID:</strong> <span class="info">${import.meta.env.VITE_GOOGLE_CLIENT_ID || 'NOT FOUND'}</span></p>
            <p><strong>Fallback Client ID:</strong> <span class="info">${clientId}</span></p>
            <p><strong>VITE_BACKEND_URL:</strong> <span class="info">${backendUrl}</span></p>
            <p><strong>Mode:</strong> ${import.meta.env.MODE}</p>
            <p><strong>Prod:</strong> ${import.meta.env.PROD}</p>
            <p><strong>Dev:</strong> ${import.meta.env.DEV}</p>
        `;
        
        addLog('üîç P√°gina de debug carregada');
        addLog(`üîë Client ID carregado: ${clientId}`);
        addLog(`üåê Backend URL: ${backendUrl}`);
        
        // Teste de popup real
        document.getElementById('test-popup-btn').addEventListener('click', () => {
            addLog('üöÄ Iniciando teste de popup...');
            
            const state = 'test_' + Math.random().toString(36).substring(2, 15);
            let redirectUri;
            
            // Construir redirect_uri corretamente como no c√≥digo principal
            if (backendUrl.includes('/api')) {
                const baseUrl = backendUrl.replace(/\/api$/, '');
                redirectUri = `${baseUrl}/auth/google/callback`;
            } else {
                redirectUri = `${backendUrl}/auth/google/callback`;
            }
            
            const params = new URLSearchParams({
                client_id: clientId,
                redirect_uri: redirectUri,
                response_type: 'code',
                scope: 'openid email profile',
                state: state,
                access_type: 'offline',
                prompt: 'consent'
            });
            
            const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?${params.toString()}`;
            
            addLog(`üéØ Redirect URI: ${redirectUri}`);
            addLog(`üîó Auth URL gerada: ${authUrl.substring(0, 100)}...`);
            
            popupInfo.innerHTML = `
                <p class="info">Estado: ${state}</p>
                <p class="info">Redirect URI: ${redirectUri}</p>
                <p class="info">Client ID: ${clientId}</p>
                <pre>${authUrl}</pre>
            `;
            
            // Abrir popup
            const popup = window.open(
                authUrl,
                'google-oauth-test',
                'width=500,height=600,scrollbars=yes,resizable=yes,status=yes,location=yes,toolbar=no,menubar=no'
            );
            
            if (!popup) {
                addLog('‚ùå Popup foi bloqueado pelo navegador', 'error');
                popupInfo.innerHTML += '<p class="error">‚ùå Popup bloqueado! Permita popups para este site.</p>';
                return;
            }
            
            addLog('‚úÖ Popup aberto com sucesso');
            
            // Monitorar popup
            const checkClosed = setInterval(() => {
                if (popup.closed) {
                    clearInterval(checkClosed);
                    addLog('üîí Popup foi fechado');
                }
            }, 1000);
            
            // Timeout
            setTimeout(() => {
                if (!popup.closed) {
                    popup.close();
                    clearInterval(checkClosed);
                    addLog('‚è∞ Popup fechado por timeout', 'error');
                }
            }, 60000);
        });
        
        // Teste Google Identity Services
        document.getElementById('test-gsi-btn').addEventListener('click', () => {
            addLog('üîß Testando Google Identity Services...');
            
            if (window.google && window.google.accounts && window.google.accounts.id) {
                try {
                    addLog('‚úÖ GSI dispon√≠vel, inicializando...');
                    
                    window.google.accounts.id.initialize({
                        client_id: clientId,
                        callback: (response) => {
                            addLog('üéØ Token recebido via GSI!', 'success');
                            gsiInfo.innerHTML += `<p class="success">Token recebido: ${response.credential.substring(0, 50)}...</p>`;
                        },
                        auto_select: false,
                        cancel_on_tap_outside: true,
                        context: 'signin',
                        ux_mode: 'popup'
                    });
                    
                    addLog('‚úÖ GSI inicializado, tentando prompt...');
                    
                    window.google.accounts.id.prompt((notification) => {
                        if (notification.isDisplayed()) {
                            addLog('‚úÖ Prompt GSI exibido com sucesso', 'success');
                            gsiInfo.innerHTML += '<p class="success">‚úÖ Prompt exibido com sucesso</p>';
                        } else if (notification.isNotDisplayed()) {
                            const reason = notification.getNotDisplayedReason();
                            addLog(`‚ùå Prompt n√£o exibido: ${reason}`, 'error');
                            gsiInfo.innerHTML += `<p class="error">‚ùå Prompt n√£o exibido: ${reason}</p>`;
                        }
                    });
                } catch (error) {
                    addLog(`‚ùå Erro no GSI: ${error.message}`, 'error');
                    gsiInfo.innerHTML += `<p class="error">‚ùå Erro: ${error.message}</p>`;
                }
            } else {
                addLog('‚ùå Google Identity Services n√£o est√° dispon√≠vel', 'error');
                gsiInfo.innerHTML += '<p class="error">‚ùå GSI n√£o dispon√≠vel</p>';
            }
        });
    </script>
</body>
</html>
